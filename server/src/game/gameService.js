const path = require('path');

// Use absolute path to shared module
const {
  createGame,
  createBoard,
  applyClue,
  selectWord,
  endTurn,
  checkWinCondition
} = require(path.join(__dirname, '../../../shared/game-engine'));

const CODENAMES_WORDS = [
  'أفريقيا', 'عميل', 'هواء', 'فضائي', 'جبال الألب', 'أمازون', 'إسعاف', 'أمريكا',
  'ملاك', 'أنتاركتيكا', 'تفاحة', 'ذراع', 'أطلانتس', 'أستراليا', 'أزتيك',
  'ظهر', 'كرة', 'فرقة', 'بنك', 'بار', 'لحاء', 'خفاش', 'بطارية', 'شاطئ',
  'دب', 'إيقاع', 'سرير', 'بكين', 'جرس', 'حزام', 'برلين', 'برمودا',
  'توت', 'فاتورة', 'مكعب', 'لوح', 'برغي', 'قنبلة', 'رابطة', 'انفجار', 'حذاء',
  'زجاجة', 'قوس', 'صندوق', 'جسر', 'فرشاة', 'دولار', 'جاموس', 'حشرة', 'بوق',
  'زر', 'عجل', 'كندا', 'قبعة', 'عاصمة', 'سيارة', 'ورقة', 'جزرة',
  'كازينو', 'تمثيل', 'قط', 'خلية', 'قنطور', 'مركز', 'كرسي', 'تغيير',
  'شحنة', 'شيك', 'صدر', 'كتكوت', 'صين', 'شوكولاتة', 'كنيسة',
  'دائرة', 'جرف', 'عباءة', 'نادي', 'رمز', 'برد', 'كوميدي', 'مركب',
  'حفلة موسيقية', 'موصل', 'عقد', 'طباخ', 'نحاس', 'قطن', 'محكمة',
  'غطاء', 'رافعة', 'حادث', 'كريكت', 'صليب', 'تاج', 'دورة', 'تشيك',
  'رقص', 'تاريخ', 'يوم', 'موت', 'سطح', 'درجة', 'ألماس', 'نرد',
  'ديناصور', 'مرض', 'طبيب', 'كلب', 'مسودة', 'تنين', 'فستان',
  'مثقاب', 'قطرة', 'بطة', 'قزم', 'نسر', 'مصر', 'مصعد', 'جن',
  'محرك', 'إنجلترا', 'أوروبا', 'عين', 'وجه', 'معرض', 'سقوط', 'مروحة',
  'سياج', 'حقل', 'مقاتل', 'شخصية', 'ملف', 'فيلم', 'نار', 'سمك',
  'شقة', 'فيضان', 'أرضية', 'ناي', 'ذبابة', 'قدم', 'قوة', 'غابة',
  'شوكة', 'فرنسا', 'لعبة', 'غاز', 'عبقري', 'ألمانيا', 'شبح', 'عملاق',
  'زجاج', 'قفاز', 'ذهب', 'نعمة', 'عشب', 'اليونان', 'أخضر', 'أرض',
  'لحم', 'يد', 'صقر', 'رأس', 'قلب', 'هليكوبتر', 'هيمالايا', 'حفرة',
  'هوليوود', 'عسل', 'غطاء محرك', 'خطاف', 'قرن', 'حصان', 'حدوة',
  'مستشفى', 'فندق', 'جليد', 'آيس كريم', 'الهند', 'حديد', 'عاج', 'جاك',
  'مربى', 'طائرة نفاثة', 'المشتري', 'كنغر', 'كاتشب', 'مفتاح', 'طفل', 'ملك',
  'كيوي', 'سكين', 'فارس', 'مختبر', 'حضن', 'ليزر', 'محام', 'رصاص',
  'ليمون', 'قزم أيرلندي', 'حياة', 'ضوء', 'ليموزين', 'خط', 'رابط',
  'أسد', 'قمامة', 'لوخ نيس', 'قفل', 'سجل', 'لندن', 'حظ', 'بريد',
  'ماموث', 'قيقب', 'رخام', 'مارس', 'كتلة', 'كبريت', 'عطارد', 'المكسيك',
  'ميكروسكوب', 'مليونير', 'منجم', 'نعناع', 'صاروخ', 'نموذج', 'خلد',
  'قمر', 'موسكو', 'جبل', 'فأر', 'فم', 'كوب', 'ظفر', 'إبرة',
  'شبكة', 'نيويورك', 'ليل', 'نينجا', 'ملاحظة', 'رواية', 'ممرضة', 'جوز',
  'أخطبوط', 'زيت', 'زيتون', 'أولمبوس', 'بصل', 'أوبرا', 'برتقال', 'أعضاء',
  'نخلة', 'مقلاة', 'بنطلون', 'ورق', 'مظلة', 'حديقة', 'جزء', 'مرور',
  'عجينة', 'بطريق', 'عنقاء', 'بيانو', 'فطيرة', 'طيار', 'دبوس', 'أنبوب',
  'قرصان', 'مسدس', 'حفرة', 'ملعب', 'طائرة', 'بلاستيك', 'صحن', 'خلد الماء',
  'لعب', 'حبكة', 'نقطة', 'سم', 'قطب', 'شرطة', 'مسبح', 'ميناء',
  'بريد', 'جنيه', 'صحافة', 'أميرة', 'يقطينة', 'تلميذ', 'هرم',
  'ملكة', 'أرنب', 'مضرب', 'شعاع', 'ثورة', 'خاتم', 'روبن', 'روبوت',
  'صخرة', 'روما', 'جذر', 'وردة', 'روليت', 'جولة', 'صف', 'مسطرة',
  'قمر صناعي', 'زحل', 'ميزان', 'مدرسة', 'عالم', 'عقرب',
  'شاشة', 'غواص', 'فقمة', 'خادم', 'ظل', 'شكسبير',
  'قرش', 'سفينة', 'حذاء', 'محل', 'طلقة', 'حوض', 'ناطحة سحاب', 'انزلاق',
  'بزاقة', 'مهرب', 'ثلج', 'رجل ثلج', 'جورب', 'جندي', 'روح',
  'صوت', 'فضاء', 'تعويذة', 'عنكبوت', 'شوكة', 'عمود فقري', 'بقعة', 'ربيع',
  'جاسوس', 'مربع', 'ملعب', 'عصا', 'نجم', 'دولة', 'عصا', 'مخزون',
  'قش', 'تيار', 'إضراب', 'خيط', 'غواصة', 'بدلة', 'بطل خارق',
  'أرجوحة', 'مفتاح', 'طاولة', 'جهاز لوحي', 'بطاقة', 'ذيل', 'صنبور', 'معلم',
  'تلسكوب', 'معبد', 'مسرح', 'لص', 'إبهام', 'قراد', 'ربطة',
  'وقت', 'طوكيو', 'سن', 'شعلة', 'برج', 'مسار', 'قطار', 'مثلث',
  'رحلة', 'جذع', 'أنبوب', 'ديك رومي', 'جنازي', 'حيد القرن', 'مكنسة كهربائية',
  'سيارة', 'طبيب بيطري', 'استيقاظ', 'جدار', 'حرب', 'غسالة', 'واشنطن', 'ساعة',
  'ماء', 'موجة', 'شبكة', 'بئر', 'حوت', 'سوط', 'رياح', 'ساحرة',
  'دودة', 'حديقة'
];

class GameService {
  constructor() {
    this.games = new Map();
  }

  startGame(roomId) {
    // Create new game state using shared engine
    let game = createGame(roomId);
    
    // Create board with shuffled words
    const shuffledWords = this.shuffleArray([...CODENAMES_WORDS]);
    const board = createBoard(shuffledWords);
    
    game = {
      ...game,
      board
    };

    this.games.set(roomId, game);
    return game;
  }

  getGame(roomId) {
    return this.games.get(roomId);
  }

  applyClue(roomId, clue, team) {
    const game = this.games.get(roomId);
    if (!game) {
      throw new Error('Game not found');
    }

    const newGame = applyClue(game, clue, team);
    this.games.set(roomId, newGame);
    return newGame;
  }

  selectWord(roomId, cardId, team) {
    const game = this.games.get(roomId);
    if (!game) {
      throw new Error('Game not found');
    }

    const newGame = selectWord(game, cardId, team);
    this.games.set(roomId, newGame);
    return newGame;
  }

  endTurn(roomId, team) {
    const game = this.games.get(roomId);
    if (!game) {
      throw new Error('Game not found');
    }

    const newGame = endTurn(game, team);
    this.games.set(roomId, newGame);
    return newGame;
  }

  checkWinCondition(roomId) {
    const game = this.games.get(roomId);
    if (!game) {
      throw new Error('Game not found');
    }

    return checkWinCondition(game);
  }

  endGame(roomId) {
    const game = this.games.get(roomId);
    if (game) {
      game.phase = 'END';
      this.games.set(roomId, game);
    }
    return game;
  }

  shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }

  removeGame(roomId) {
    this.games.delete(roomId);
  }
}

module.exports = GameService;
